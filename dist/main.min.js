var app=angular.module("openQuest",["ui.router","ngMessages","ngAnimate","ngSanitize","ui.bootstrap","ui.bootstrap.datetimepicker","colorpicker.module"]);app.config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("auth",{url:"/",templateUrl:"views/auth.html",controller:"loginCtrl"}).state("main",{"abstract":!0,url:"/main",templateUrl:"views/main.html",controller:"mainCtrl",resolve:{getData:["dataService",function(t){return t.getData().then(function(e){t.quests=e.quests||[],t.categories=e.categories||[]})}]}}).state("main.dashboard",{url:"/dashboard",templateUrl:"views/dashboard.html",controller:"dashboardCtrl"}).state("main.quests",{url:"/quests",templateUrl:"views/quests.html",controller:"questsCtrl"}).state("main.quests.questDetail",{url:"/quests/:id",templateUrl:"views/questDetail.html",controller:"questsCtrl"}).state("main.adventures",{url:"/adventures",templateUrl:"views/adventures.html"}).state("main.questCreation",{url:"/questCreation",templateUrl:"views/questCreation.html",controller:"questCreationCtrl"}).state("main.adventureCreation",{url:"/adventureCreation",templateUrl:"views/adventureCreation.html"}).state("main.settings",{url:"/settings",templateUrl:"views/settings.html"}),e.otherwise("/main/dashboard")}]),app.filter("questStatus",function(){return function(t,e){var a=[],n=function(e){var n=t.filter(function(t){return t.status==e});a=a.concat(n)};return e.forEach(n),a}}),app.controller("loginCtrl",["$scope","$uibModal","auth",function(t,e,a){t.loginData={email:"",password:""},t.signupData={email:"",password:"",repeatPassword:""},t.errors={login:"",signup:"",signupSuccess:""},t.login=a.login,t.signup=a.signup,t.openModal=function(){e.open({templateUrl:"authModal.html",controller:"loginCtrl"})}}]),app.controller("mainCtrl",["$scope","auth",function(t,e){e.checkToken(),t.logout=e.logout}]),app.controller("dashboardCtrl",["$scope","dataService",function(t,e){t.categories=e.categories,t.quests=e.quests}]),app.controller("questsCtrl",["$scope","$window","$state","$stateParams","dataService",function(t,e,a,n,o){t.quests=o.quests,t.statuses=["active"],t.include=function(e){-1!=t.statuses.indexOf(e)?t.statuses.splice(t.statuses.indexOf(e),1):t.statuses.push(e)},e.innerWidth<580&&(t.collapsed=!0),t.selectedQuest=n.id,t.state=a,t.calculateTime=function(t){var e=(new Date).getTime();if(e>t)return"none";var a=Math.round(Math.abs((e-t)/6e4)),n="minutes";return a>1440?(a/=1440,n="days"):a>59&&(a/=60,n="hours"),Math.round(a)+" "+n},t.snippet="Pretty text with some links:\nhttp://angularjs.org/,\nmailto:us@somewhere.org,\nanother@somewhere.org,\nand one more: ftp://127.0.0.1/."}]),app.controller("questCreationCtrl",["$scope","$http","dataService",function(t,e,a){t.categories=a.categories,t.adventures=[],t.datePicker={isOpen:!1,min:new Date,options:{startingDay:1,"show-weeks":!1},timeOptions:{"show-meridian":!1},open:function(){this.isOpen=!0}},t.quest={},t.newCategory={name:""},t.$watch("newCategory.name",function(e){e.length>0?(t.quest.category="",t.categoryError=!1):t.categories&&t.categories.length>0&&(t.quest.category=t.categories[0].id)}),t.createQuest=function(){if(!t.quest.category&&!t.newCategory.name)return void(t.categoryError=!0);t.quest.deadline&&(t.quest.deadline=new Date(t.quest.deadline).getTime());var e=function(){t.createdQuest=!0,t.quest={}};t.newCategory.name?(t.newCategory.background&&(t.newCategory.color=parseInt(t.newCategory.background.replace("#",""),16)>8388607.5?"#000":"#fff"),a.createEntity(t.newCategory,"categories",function(){t.quest.category=a.categories[a.categories.length-1].id,t.newCategory={name:""},a.createEntity(t.quest,"quests",e)})):a.createEntity(t.quest,"quests",e)}}]),app.service("auth",["$http","$state",function(t,e){var a=this;a.checkToken=function(){localStorage.token&&"LOGGED OUT"!=localStorage.token||e.go("auth"),t.post("backend/checkToken.php",localStorage.token).then(function(t){"authorized"==t.data?console.log("you're logged in"):e.go("auth")})},a.login=function(a,n){t.post("backend/login.php",JSON.stringify(a)).then(function(t){-1!=t.data.indexOf("Ooops")?n.login=t.data:(localStorage.token=t.data,e.go("main.dashboard"))},function(t){console.error(t)})},a.signup=function(e,a,n){n&&t.post("backend/signup.php",JSON.stringify(e)).then(function(t){"error"==t.data?a.signup="This email is already linked to an account":(a.signup="",a.signupSuccess=t.data)},function(t){console.log(t)})},a.logout=function(){t.post("backend/logout.php",localStorage.token).then(function(){localStorage.clear(),e.go("auth")},function(t){console.error(t)})}}]),app.service("dataService",["$http","$q",function(t,e){var a=this;a.getData=function(){var a=e.defer();return t.get("backend/getUserData.php?token="+localStorage.token).success(function(t){a.resolve(t)}).error(function(t){a.reject(t)}),a.promise},a.createEntity=function(e,n,o){t.post("backend/createEntity.php?token="+localStorage.token+"&table="+n,JSON.stringify(e)).then(function(t){a[n].push(t.data),o()})},a.updateEntity=function(e,n,o,r){var i={type:e,id:n,column:o,value:r};t.post("backend/updateEntity.php?token="+localStorage.token,JSON.stringify(i)).then(function(){a[e].forEach(function(t){t.id===n&&(t[o]=r)})})}}]),app.directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(t,e,a,n){n.$validators.compareTo=function(e){return e==t.otherModelValue},t.$watch("otherModelValue",function(){n.$validate()})}}}),app.directive("oqNavbar",function(){return{scope:{title:"@",icon:"@"},templateUrl:"views/directives/navbar.html"}}),app.directive("oqLabel",function(){return{templateUrl:"views/directives/label.html"}}),app.directive("buttonBar",["dataService",function(t){return{templateUrl:"views/directives/buttonBar.html",scope:{quest:"="},link:function(e){e.update=t.updateEntity}}}]);