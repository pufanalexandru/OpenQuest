var app=angular.module("openQuest",["ui.router","ngMessages"]);app.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("auth",{url:"/",templateUrl:"views/auth.html",controller:"loginCtrl"}).state("main",{"abstract":!0,url:"/main",templateUrl:"views/main.html",controller:"mainCtrl",resolve:{getData:["dataService",function(e){e.quests||e.fetchData()}]}}).state("main.dashboard",{url:"/dashboard",templateUrl:"views/dashboard.html",controller:"dashboardCtrl"}).state("main.quests",{url:"/quests",templateUrl:"views/quests.html",controller:"questsCtrl"}).state("main.adventures",{url:"/adventures",templateUrl:"views/adventures.html"}).state("main.questCreation",{url:"/questCreation",templateUrl:"views/questCreation.html",controller:"questCreationCtrl"}).state("main.adventureCreation",{url:"/adventureCreation",templateUrl:"views/adventureCreation.html"}).state("main.settings",{url:"/settings",templateUrl:"views/settings.html"}),t.otherwise("/main/dashboard")}]),app.filter("questStatus",function(){return function(e,t){var a=[],o=function(t){var o=e.filter(function(e){return parseInt(e[t])});a=a.concat(o)};for(var n in t)t[n]&&o(n);return a}}),app.controller("loginCtrl",["$scope","auth",function(e,t){e.loginData={email:"",password:""},e.signupData={email:"",password:"",repeatPassword:""},e.errors={login:"",signup:"",signupSuccess:""},e.login=t.login,e.signup=t.signup}]),app.controller("mainCtrl",["$scope","auth",function(e,t){t.checkToken(),e.logout=t.logout,$("#menu li").click(function(){$("#menu").removeClass("in")})}]),app.controller("dashboardCtrl",["$scope","dataService",function(e,t){e.categories=t.categories,e.quests=t.quests}]),app.controller("questsCtrl",["$scope","$window","$timeout","dataService",function(e,t,a,o){e.quests=o.quests,e.quests||a(function(){e.quests=o.quests},500),e.checkboxes={active:!0,completed:!1,failed:!1},e.toggle=function(){var e="31px"==$("#quest-content").css("margin-left")?230:31;$("#quest-content").animate({"margin-left":e}),$("#quest-sidebar").animate({width:e}),$("#quest-sidebar i").toggleClass("fa-chevron-right"),$("#quest-sidebar").toggleClass("collapsed")},t.innerWidth<580&&e.toggle()}]),app.controller("questCreationCtrl",["$scope","$http","dataService",function(e,t,a){$(".colorPicker").colorpicker({format:"hex"}),$(".colorPicker").on("changeColor",function(){e.newCategory.background=$("input.colorPicker").val()}),$("#datetimepicker").datetimepicker({minDate:new Date,format:"YYYY/MM/DD HH:mm"}),$("#datetimepicker").on("dp.change",function(){e.quest.deadline=$("input#deadline").val()}),$("#adventure").bootstrapToggle({on:"Yes",off:"No"}),e.quest={name:"",description:"",deadline:"",category:"",hasAdventure:!1,adventure:""},e.newCategory={name:"",color:"",background:""},e.categories=a.categories,e.$watch("newCategory.name",function(t){t.length>0?(e.quest.category="",e.categoryError=!1):e.categories&&e.categories.length>0&&(e.quest.category=e.categories[0].id)}),e.adventures=[],e.toggleAdventures=function(){e.quest.hasAdventure=!e.quest.hasAdventure},e.createQuest=function(){if(!e.quest.category&&!e.newCategory.name)return void(e.categoryError=!0);e.quest.hasAdventure&&!e.quest.adventure&&(e.quest.hasAdventure=!1,$("#adventure").bootstrapToggle("off")),e.quest.hasAdventure||(e.quest.adventure=""),e.quest.deadline=new Date(e.quest.deadline),"Invalid Date"==e.quest.deadline&&(e.quest.deadline="");var a={};for(var o in e.quest)e.quest[o]&&"hasAdventure"!=o&&(a[o]=e.quest[o]);var n=function(){t.post("backend/createQuest.php?token="+localStorage.token,JSON.stringify(a)).then(function(t){"success"==t.data&&(e.createdQuest=!0,e.quest={})})};e.newCategory.name?(e.newCategory.background=e.newCategory.background||"#0B7BB7",e.newCategory.color=parseInt(e.newCategory.color.replace("#",""),16)>8388607.5?"#000":"#fff",t.post("backend/createCategory.php?token="+localStorage.token,JSON.stringify(e.newCategory)).then(function(e){console.log(e),a.category=e.data,n()})):n()}}]),app.service("auth",["$http","$state","dataService",function(e,t,a){var o=this;o.checkToken=function(){localStorage.token&&"LOGGED OUT"!=localStorage.token||t.go("auth"),e.post("backend/checkToken.php",localStorage.token).then(function(e){"authorized"==e.data?console.log("you're logged in"):t.go("auth")})},o.login=function(o,n){e.post("backend/login.php",JSON.stringify(o)).then(function(e){-1!=e.data.indexOf("Ooops")?n.login=e.data:(localStorage.token=e.data,a.fetchData(function(){t.go("main.dashboard")}))},function(e){console.error(e)})},o.signup=function(t,a,o){o?e.post("backend/signup.php",JSON.stringify(t)).then(function(e){"error"==e.data?a.signup="This email is already linked to an account":(a.signup="",a.signupSuccess=e.data)},function(e){console.log(e)}):a.signup="It seems that your data is incorrect"},o.logout=function(){e.post("backend/logout.php",localStorage.token).then(function(){localStorage.clear(),t.go("auth")},function(e){console.error(e)})}}]),app.service("dataService",["$http","$q",function(e,t){var a=this;a.getData=function(){var a=t.defer();return e.get("backend/getUserData.php?token="+localStorage.token).success(function(e){a.resolve(e)}).error(function(e){a.reject(e)}),a.promise},a.fetchData=function(e){a.getData().then(function(t){a.categories=t.categories||[],a.quests=t.quests||[],console.log(a.quests),e&&e()})}}]),app.directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(e,t,a,o){o.$validators.compareTo=function(t){return t==e.otherModelValue},e.$watch("otherModelValue",function(){o.$validate()})}}}),app.directive("oqNavbar",function(){return{scope:{title:"@title",icon:"@icon"},templateUrl:"views/directives/navbar.html"}});