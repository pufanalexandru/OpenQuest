"use strict";var app=angular.module("openQuest",["ui.router","ngMessages","ngAnimate","ngSanitize","ui.bootstrap","ui.bootstrap.datetimepicker","colorpicker.module"]);app.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("auth",{url:"/",templateUrl:"views/auth.html",controller:"loginCtrl"}).state("main",{"abstract":!0,url:"/main",templateUrl:"views/main.html",controller:"mainCtrl",resolve:{getData:["dataService",function(e){return e.getData().then(function(t){e.quests=t.quests||[],e.categories=t.categories||[]})}]}}).state("main.dashboard",{url:"/dashboard",templateUrl:"views/dashboard.html",controller:"dashboardCtrl"}).state("main.quests",{url:"/quests",templateUrl:"views/quests.html",controller:"questsCtrl"}).state("main.quests.questDetail",{url:"/quests/:id",templateUrl:"views/questDetail.html",controller:"questsCtrl"}).state("main.adventures",{url:"/adventures",templateUrl:"views/adventures.html"}).state("main.questCreation",{url:"/questCreation",templateUrl:"views/questCreation.html",controller:"questCreationCtrl"}).state("main.adventureCreation",{url:"/adventureCreation",templateUrl:"views/adventureCreation.html"}).state("main.settings",{url:"/settings",templateUrl:"views/settings.html"}),t.otherwise("/main/dashboard")}]),app.filter("questStatus",function(){return function(e,t){var n=[],a=function(t){var a=e.filter(function(e){return e.status==t});n=n.concat(a)};return t.forEach(a),n}}),app.controller("loginCtrl",["$scope","$uibModal","auth",function(e,t,n){e.loginData={email:"",password:""},e.signupData={email:"",password:"",repeatPassword:""},e.errors={login:"",signup:"",signupSuccess:""},e.login=n.login,e.signup=n.signup,e.openModal=function(){t.open({templateUrl:"authModal.html",controller:"loginCtrl"})}}]),app.controller("mainCtrl",["$scope","auth",function(e,t){t.checkToken(),e.logout=t.logout}]),app.controller("dashboardCtrl",["$scope","dataService",function(e,t){e.categories=t.categories,e.quests=t.quests}]),app.controller("questsCtrl",["$scope","$window","$state","$stateParams","dataService",function(e,t,n,a,o){e.quests=o.quests,e.message=0===e.quests.length?"No quests created":"Choose a quest from the list",e.statuses=["active"],e.include=function(t){-1!=e.statuses.indexOf(t)?e.statuses.splice(e.statuses.indexOf(t),1):e.statuses.push(t)},t.innerWidth<580&&(e.collapsed=!0),e.selectedQuest=a.id,e.state=n,e.calculateTime=function(e){var t=(new Date).getTime();if(t>e)return"none";var n=Math.round(Math.abs((t-e)/6e4)),a="minutes";return n>1440?(n/=1440,a="days"):n>59&&(n/=60,a="hours"),Math.round(n)+" "+a}}]),app.controller("questCreationCtrl",["$scope","$http","dataService",function(e,t,n){e.categories=n.categories,e.adventures=[],e.datePicker={isOpen:!1,min:new Date,options:{startingDay:1,"show-weeks":!1},timeOptions:{"show-meridian":!1},open:function(){this.isOpen=!0}},e.quest={},e.newCategory={name:""},e.$watch("newCategory.name",function(t){t.length>0?(e.quest.category="",e.categoryError=!1):e.categories&&e.categories.length>0&&(e.quest.category=e.categories[0].id)}),e.createQuest=function(){if(!e.quest.category&&!e.newCategory.name)return void(e.categoryError=!0);e.quest.deadline&&(e.quest.deadline=new Date(e.quest.deadline).getTime());var t=function(){e.createdQuest=!0,e.quest={}};e.newCategory.name?(e.newCategory.background&&(e.newCategory.color=parseInt(e.newCategory.background.replace("#",""),16)>8388607.5?"#000":"#fff"),n.createEntity(e.newCategory,"categories",function(){e.quest.category=n.categories[n.categories.length-1].id,e.newCategory={name:""},n.createEntity(e.quest,"quests",t)})):n.createEntity(e.quest,"quests",t)}}]),app.service("auth",["$http","$state",function(e,t){this.checkToken=function(){localStorage.token&&"LOGGED OUT"!=localStorage.token||t.go("auth"),e.post("backend/checkToken.php",localStorage.token).then(function(e){"authorized"==e.data?console.log("you're logged in"):t.go("auth")})},this.login=function(n,a){e.post("backend/login.php",JSON.stringify(n)).then(function(e){e.data.includes("Ooops")?a.login=e.data:(localStorage.token=e.data,t.go("main.dashboard"))},function(e){console.error(e)})},this.signup=function(t,n,a){a&&e.post("backend/signup.php",JSON.stringify(t)).then(function(e){"error"==e.data?n.signup="This email is already linked to an account":(n.signup="",n.signupSuccess=e.data)},function(e){console.log(er)})},this.logout=function(){e.post("backend/logout.php",localStorage.token).then(function(){localStorage.clear(),t.go("auth")},function(e){console.error(e)})}}]),app.service("dataService",["$http","$q",function(e,t){var n=this;this.getData=function(){var n=t.defer();return e.get("backend/getUserData.php?token="+localStorage.token).success(function(e){n.resolve(e)}).error(function(e){n.reject(e)}),n.promise},this.createEntity=function(t,a,o){e.post("backend/createEntity.php?token="+localStorage.token+"&table="+a,JSON.stringify(t)).then(function(e){n[a].push(e.data),o()})},this.updateEntity=function(t,a,o,r){var i={type:t,id:a,property:o,value:r};e.post("backend/updateEntity.php?token="+localStorage.token,JSON.stringify(i)).then(function(){n[t].forEach(function(e){e.id===a&&(e[o]=r)})})},this.deleteEntity=function(t,a,o){if(confirm("Are you sure?")){var r={type:t,id:a};e.post("backend/deleteEntity.php?token="+localStorage.token,JSON.stringify(r)).then(function(){n[t].forEach(function(e,o){e.id===a&&n[t].splice(o,1)}),o()})}}}]),app.directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(e,t,n,a){a.$validators.compareTo=function(t){return t==e.otherModelValue},e.$watch("otherModelValue",function(){a.$validate()})}}}),app.directive("oqNavbar",function(){return{scope:{title:"@",icon:"@"},templateUrl:"views/directives/navbar.html"}}),app.directive("oqLabel",function(){return{templateUrl:"views/directives/label.html"}}),app.directive("oqButtonBar",["$state","dataService",function(e,t){return{templateUrl:"views/directives/buttonBar.html",scope:{quest:"="},link:function(n){n.deleteCallback=function(){e.go("^")},n.update=t.updateEntity,n["delete"]=t.deleteEntity}}}]),app.directive("oqEditable",function(){return{restrict:"A",link:function(e,t,n){t.on("mouseenter",function(){t.append('<em class="editable"> edit <i class="fa fa-pencil-square-o"></i></em>'),t.find("em").on("click",function(){alert("hi")})}).on("mouseleave",function(){t.find("em").remove()})}}});